# MicroShift with OpenTelemetry Tracing enabled

Follow the steps below to view OpenTelemetry trace data from MicroShift
Jaeger frontend can be viewed at `http://localhost:16686/`
The following trace services can be viewed:

```
kube-apiserver
etcd
crio
kubelet
```

#### Install MicroShift rpm and Replace MicroShift binary with OpenTelemetry instrumented binary

Follow the documentation to [Install MicroShift on RHEL for Edge](https://raw.githubusercontent.com/openshift/microshift/main/docs/rhel4edge_iso.md)

### Replace microShift binary in microshift-edge virtual machine

SSH into `microshift-edge` virtual machine

```bash
sudo systemctl stop microshift
podman run --rm -d --name microshift-bin quay.io/sallyom/microshift:otel sleep 100
podman cp microshift-bin:/usr/bin/microshift /home/redhat/
sudo mv /home/redhat/microshift /usr/local/bin/
podman cp microshift-bin:/opt/otelcol-jaeger-microshift.sh /home/redhat/
podman stop microshift-bin
```

### Configure CRI-O to export OpenTelemetry spans

SSH into `microshift-edge` virtual machine

```bash
sudo systemctl stop crio
```

Enable cri-o with tracing by adding a crio.conf.d file

```shell
sudo su
mkdir /etc/crio/crio.conf.d
cat <<EOF > /etc/crio/crio.conf.d/otel.conf
[crio.tracing]
tracing_sampling_rate_per_million=999999
enable_tracing=true
EOF

systemctl daemon-reload
systemctl start crio
systemctl start microshift
exit
```

#### Launch OpenTelemetry Collector and Jaeger pods

SSH into `microshift-edge` virtual machine and run:

```bash
/home/redhat/otelcol-jaeger-microshift.sh
```

The `otelcol-jaeger-microshift.sh` script does the following:

- starts `OpenTelemetry Collector` running as a pod on local host
- starts `Jaeger All-In-One` running as a pod on local host

### View Traces in Jaeger UI from host machine

From host machine, run:

```
ssh -L 16686:localhost:16686 redhat@microshift-edge
```

Jaeger UI will be visible from `http://localhost:16686`

### Example instrumented application

SSH into `microshift-edge` virtual machine.

Deploy an example application instrumented to export OpenTelemetry trace spans.
This application is a simple web server, service, and route.
The trace service `test-service` will be added and can be viewed in the Jaeger UI.

```bash
oc create ns otel-dev
oc apply -f https://raw.githubusercontent.com/sallyom/golang-ex/master/opentelemetry-sample-app/sample-app-microshift.yaml
oc get routes -n otel-dev
```
Trace data will be generated by reloading a counter page at `https://localhost:8080/count`
