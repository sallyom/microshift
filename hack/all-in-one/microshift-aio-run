# This script runs when microshift-aio.service is started

#!/bin/bash
set -euxo pipefail

# Install kubectl
install_kubectl() {
    ARCH=$(uname -m |sed -e "s/x86_64/amd64/" |sed -e "s/aarch64/arm64/") && \
    curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/${ARCH}/kubectl" && \
    chmod +x ./kubectl && \
    mv ./kubectl /usr/bin/kubectl
}

install_kubectl
setsebool -P container_manage_cgroup true

if ! /usr/bin/podman volume exists microshift-data
then
  /usr/bin/podman volume create microshift-data
fi

/usr/bin/podman run -d --rm \
  --name microshift-aio --privileged \
  -v /lib/modules:/lib/modules \
  -v microshift-data:/var/lib \
  --label "io.containers.autoupdate=registry" \
  -p 6443:6443 quay.io/microshift/microshift:4.7.0-0.microshift-2021-08-31-224727-aio

[[ -d /etc/microshift-aio ]] || mkdir /etc/microshift-aio
cat <<EOF > /etc/microshift-aio/microshift-aio.conf
export KUBECONFIG=$(/usr/bin/podman volume inspect microshift-vol --format "{{.Mountpoint}}")/microshift/resources/kubeadmin/kubeconfig
EOF
